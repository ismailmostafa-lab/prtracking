<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>PR Tracking System â€” Export</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  margin:0;
  background:#f4f1fb;
  font-family:'Cairo',sans-serif;
}
.header-box{
  max-width:1300px;
  margin:26px auto;
  background:linear-gradient(135deg,#A666B0,#573B92);
  padding:26px;
  border-radius:22px;
  text-align:center;
  color:#fff;
}
.card{
  max-width:600px;
  margin:80px auto;
  background:#fff;
  border-radius:24px;
  padding:60px;
  text-align:center;
}
.export-btn{
  padding:20px 60px;
  font-size:20px;
  border:none;
  border-radius:22px;
  background:linear-gradient(135deg,#A666B0,#573B92);
  color:#fff;
  cursor:pointer;
}
#status{
  margin-top:20px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="header-box">
  <div style="font-size:24px;font-weight:700">Enterprise Project Management</div>
  <div style="font-size:15px;opacity:.9">PR Tracking System â€” Export</div>
</div>

<div class="card">
  <button class="export-btn" onclick="exportData()">
    Export Full Data
  </button>
  <div id="status"></div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwdEELdIbHmxPGlRFtCqKZ-gcqxqoi4g1WLx0MnLwK3N2wlufS8_2C9NmUDiVnxTCk9/exec";

async function exportData(){
  const status = document.getElementById('status');
  status.textContent = 'Fetching data...';

  try{
    const r = await fetch(API,{
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ action:'getAllPR' })
    });

    const txt = await r.text();   // ğŸ”¥ Ù…Ù‡Ù… Ø¬Ø¯Ù‹Ø§
    console.log('RAW RESPONSE:', txt);

    let j;
    try{
      j = JSON.parse(txt);
    }catch(e){
      status.textContent = 'Invalid response from server';
      alert(txt);   // ğŸ‘ˆ Ù‡ÙŠØ·Ù„Ø¹Ù„Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©
      return;
    }

    if(j.status !== 'success'){
      status.textContent = 'Export failed';
      return;
    }

    const data = j.data;
    status.textContent = `Exporting ${data.length} row(s)...`;

    const ws = XLSX.utils.json_to_sheet(data,{cellDates:true});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'PR Data');
    XLSX.writeFile(wb,'PR_Full_Data.xlsx');

    status.textContent = 'Export completed âœ”ï¸';

  }catch(err){
    console.error(err);
    status.textContent = 'Connection error';
  }
}

  // ===== SAFE SHEET CREATION =====
  const ws = XLSX.utils.aoa_to_sheet([Object.keys(data[0])]);

  const CHUNK = 500;
  for(let i=0;i<data.length;i+=CHUNK){
    const slice = data.slice(i,i+CHUNK).map(o=>Object.values(o));
    XLSX.utils.sheet_add_aoa(ws, slice, { origin:-1 });

    status.textContent = `Processing ${Math.min(i+CHUNK,data.length)} / ${data.length}`;
    await new Promise(r=>setTimeout(r,0)); // ğŸ”¥ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¬Ù…ÙŠØ¯
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'PR Data');

  status.textContent = 'Generating file...';
  XLSX.writeFile(wb,'PR_Full_Data.xlsx');

  status.textContent = 'Export completed âœ”ï¸';
}
</script>

</body>
</html>
